<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password - Forex Mentorship</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="alternate icon" href="/favicon.ico" />
    <link rel="stylesheet" href="css/globals.css" />
    <link rel="stylesheet" href="css/components.css" />
    <link rel="stylesheet" href="css/pages/auth.css" />
  </head>
  <body class="auth-page">
    <div class="auth-wrap">
      <h1 data-i18n="Reset Password">üîë Reset Password</h1>
      <div class="msg err" id="errorMsg" style="display: none"></div>
      <div class="msg ok" id="successMsg" style="display: none"></div>
      <form
        id="setPasswordForm"
        style="flex-direction: column; gap: 16px; margin-top: 10px"
      >
        <label data-i18n="Set your new password">
          Set your new password
          <input
            type="password"
            id="newPassword"
            class="input"
            required
            minlength="8"
            placeholder="New password"
            data-i18n-placeholder="New password"
          />
        </label>
        <button
          type="submit"
          class="btn btn-primary full-width"
          data-i18n="Update Password"
        >
          Update Password
        </button>
      </form>
      <div class="links" style="margin-top: 20px; text-align: center">
        <p>
          <a href="auth-modal.html" data-i18n="Back to login"
            >‚Üê Back to login</a
          >
        </p>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/config.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const setPasswordForm = document.getElementById("setPasswordForm");
        const errorMsg = document.getElementById("errorMsg");
        const successMsg = document.getElementById("successMsg");
        // Parse access_token and refresh_token from URL fragment
        const hashParams = new URLSearchParams(window.location.hash.slice(1));
        const accessToken = hashParams.get("access_token");
        const refreshToken = hashParams.get("refresh_token");
        let sessionSet = false;
        if (accessToken && refreshToken && window.supabaseClient) {
          try {
            await window.supabaseClient.auth.setSession({
              access_token: accessToken,
              refresh_token: refreshToken,
            });
            sessionSet = true;
          } catch (err) {
            if (errorMsg) {
              errorMsg.textContent = "Session error: " + (err.message || err);
              errorMsg.style.display = "block";
              setPasswordForm.style.display = "none";
            }
          }
        } else {
          // No access token: show a helpful message and hide the form
          if (errorMsg) {
            errorMsg.textContent =
              "Auth session missing! Please use the password reset link sent to your email. If you copied the link, make sure it includes everything after the # symbol.";
            errorMsg.style.display = "block";
          }
          if (setPasswordForm) setPasswordForm.style.display = "none";
          return;
        }
        setPasswordForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          errorMsg.style.display = "none";
          successMsg.style.display = "none";
          const newPassword = document.getElementById("newPassword").value;
          if (!newPassword || newPassword.length < 8) {
            errorMsg.textContent = "Password must be at least 8 characters.";
            errorMsg.style.display = "block";
            return;
          }
          try {
            if (
              !sessionSet &&
              accessToken &&
              refreshToken &&
              window.supabaseClient
            ) {
              await window.supabaseClient.auth.setSession({
                access_token: accessToken,
                refresh_token: refreshToken,
              });
            }
            const { error } = await window.supabaseClient.auth.updateUser({
              password: newPassword,
            });
            if (error) throw error;
            successMsg.textContent = "Password updated! You can now log in.";
            successMsg.style.display = "block";
            setTimeout(() => {
              window.location.href = "auth-modal.html";
            }, 1500);
          } catch (err) {
            errorMsg.textContent = err.message || "Failed to update password.";
            errorMsg.style.display = "block";
          }
        });
      });
    </script>
  </body>
</html>
