<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard - Forex Mentorship</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="alternate icon" href="/favicon.ico" />
    <link rel="stylesheet" href="css/globals.css" />
    <link rel="stylesheet" href="css/components.css" />
    <script src="js/includes.js" defer></script>
    <style>
      .lang-selector {
        position: absolute;
        top: 18px;
        right: 24px;
        z-index: 10;
        background: #fff;
        color: #222;
        border-radius: 6px;
        border: 1px solid #ccc;
        padding: 4px 10px;
        font-size: 15px;
      }
      body.dark-mode .lang-selector {
        background: #232526;
        color: #f3f4f6;
        border: 1px solid #444;
      }
    </style>
    <style>
      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
      }
      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .user-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 700;
        font-size: 18px;
      }
      .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }
      .stat-card {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
      }
      .stat-card h3 {
        margin: 0 0 8px;
        font-size: 14px;
        color: var(--text-light);
        font-weight: 600;
      }
      .stat-card .value {
        font-size: 28px;
        font-weight: 800;
        color: var(--primary);
      }
      .section {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
      }
      .section h2 {
        margin: 0 0 16px;
        font-size: 20px;
      }
      .module-section {
        margin-bottom: 24px;
      }
      .module-section h3 {
        margin: 0 0 12px;
        font-size: 18px;
        color: var(--primary);
      }
      .material-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .material-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        transition: all 0.2s;
      }
      .material-item:hover {
        border-color: var(--primary);
        background: #f9fafb;
      }
      .material-icon {
        font-size: 24px;
      }
      .material-info {
        flex: 1;
      }
      .material-info h4 {
        margin: 0 0 4px;
        font-size: 15px;
      }
      .material-info p {
        margin: 0;
        font-size: 13px;
        color: var(--text-light);
      }
      .submission-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 8px;
      }
      .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--text-light);
      }
      .btn-small {
        padding: 8px 16px;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <!-- Consent Modal -->
    <div
      id="consentModal"
      style="
        display: none;
        position: fixed;
        z-index: 10000;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.45);
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: #fff;
          padding: 32px 24px;
          border-radius: 12px;
          max-width: 400px;
          width: 90vw;
          box-shadow: 0 4px 32px #0002;
          text-align: center;
        "
      >
        <h2 style="margin-top: 0">Consent Required</h2>
        <p style="font-size: 15px">
          To use this platform, you must agree to our
          <a href="terms.html" target="_blank">Terms of Service</a> and
          <a href="privacy.html" target="_blank">Privacy Policy</a>.
        </p>
        <button
          id="acceptConsentBtn"
          class="btn btn-primary"
          style="margin-top: 18px; width: 100%"
        >
          I Agree
        </button>
      </div>
    </div>
    <select
      id="lang-selector"
      class="lang-selector"
      aria-label="Select language"
    >
      <option value="en">English</option>
      <option value="zh">‰∏≠Êñá</option>
      <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
      <option value="es">Espa√±ol</option>
    </select>
    <!-- <div data-include="partials/header.html"></div> -->

    <main class="container">
      <div class="dashboard-header">
        <div style="display: flex; align-items: center; gap: 18px">
          <a
            href="index.html"
            class="btn btn-secondary btn-small"
            style="margin-right: 8px"
          >
            <span style="font-size: 16px; vertical-align: middle">üè†</span> Home
          </a>
          <div class="user-info">
            <div class="user-avatar" id="userAvatar">üë§</div>
            <div>
              <h1
                style="margin: 0; font-size: 24px"
                id="userName"
                data-i18n="Student"
              >
                Loading...
              </h1>
              <p
                style="margin: 0; color: var(--text-light); font-size: 14px"
                id="userEmail"
              ></p>
            </div>
          </div>
        </div>
        <div style="display: flex; gap: 12px; align-items: center">
          <span class="pill" id="userTier">LOADING</span>
          <button
            onclick="logout()"
            class="btn btn-secondary"
            data-i18n="Logout"
          >
            Logout
          </button>
        </div>
      </div>

      <div class="stat-grid">
        <div class="stat-card">
          <h3 data-i18n="Account Status">Account Status</h3>
          <div class="value" id="accountStatus">Active</div>
        </div>
        <div class="stat-card">
          <h3 data-i18n="Tier Level">Tier Level</h3>
          <div class="value" id="tierLevel">-</div>
        </div>
        <div class="stat-card">
          <h3 data-i18n="Modules Available">Modules Available</h3>
          <div class="value" id="coursesCount">0</div>
        </div>
        <div class="stat-card">
          <h3 data-i18n="Last Login">Last Login</h3>
          <div class="value" style="font-size: 16px" id="lastLogin">-</div>
        </div>
      </div>

      <div class="section">
        <h2 data-i18n="Your Course Materials">üìö Your Course Materials</h2>
        <div id="courseMaterials">
          <div class="empty-state" data-i18n="Loading courses...">
            Loading courses...
          </div>
        </div>
      </div>

      <div class="section">
        <h2 data-i18n="Payment History">üí≥ Payment History</h2>
        <div id="paymentHistory">
          <div class="empty-state" data-i18n="Loading payments...">
            Loading payments...
          </div>
        </div>
        <a
          href="submit-payment.html"
          class="btn btn-primary"
          style="margin-top: 12px"
          data-i18n="Submit New Payment"
          >Submit New Payment</a
        >
      </div>

      <div class="section">
        <h2 data-i18n="FTMO Submissions">üèÜ FTMO Submissions</h2>
        <div id="ftmoHistory">
          <div class="empty-state" data-i18n="Loading FTMO submissions...">
            Loading FTMO submissions...
          </div>
        </div>
        <a
          href="submit-ftmo.html"
          class="btn btn-primary"
          style="margin-top: 12px"
          data-i18n="Submit FTMO Challenge"
          >Submit FTMO Challenge</a
        >
      </div>
    </main>

    <!-- <div data-include="partials/footer.html"></div> -->

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/config.js"></script>
    <script src="js/auth-guard.js"></script>
    <script>
      // Ensure Supabase client is initialized before anything else
      if (typeof initSupabaseClient === "function") {
        initSupabaseClient();
      } else if (
        window.supabase &&
        typeof window.supabase.createClient === "function"
      ) {
        // fallback if config.js is loaded late
        window.supabaseClient = window.supabase.createClient(
          "https://dgbfqtmffgkamfgskkks.supabase.co",
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRnYmZxdG1mZmdrYW1mZ3Nra2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MDkxNjYsImV4cCI6MjA3ODE4NTE2Nn0.qfePtu3UjQBNEy6bIYJnGSva4yZJ3H8PF5PK69MM_mQ"
        );
      }
      // Consent logic
      function showConsentModal() {
        document.getElementById("consentModal").style.display = "flex";
        document.body.style.overflow = "hidden";
      }
      function hideConsentModal() {
        document.getElementById("consentModal").style.display = "none";
        document.body.style.overflow = "";
      }
      function hasStudentConsent() {
        return localStorage.getItem("studentConsentAccepted") === "true";
      }
      function setStudentConsent() {
        localStorage.setItem("studentConsentAccepted", "true");
      }
      document.addEventListener("DOMContentLoaded", function () {
        if (!hasStudentConsent()) {
          showConsentModal();
          document
            .getElementById("consentModal")
            .addEventListener("click", function (e) {
              if (e.target === this) {
                // Prevent closing by clicking backdrop
                e.stopPropagation();
              }
            });
          document.getElementById("acceptConsentBtn").onclick = function () {
            setStudentConsent();
            hideConsentModal();
            location.reload();
          };
        }
      });
      let currentUser = null;

      document.addEventListener("DOMContentLoaded", async () => {
        if (!hasStudentConsent()) {
          // Block dashboard logic until consent is given
          return;
        }
        console.log("üîÑ Student dashboard loading...");

        // Check Supabase client
        if (!window.supabaseClient) {
          console.error("‚ùå Supabase client is NOT initialized!");
          const main = document.querySelector("main.container");
          if (main) {
            main.innerHTML =
              '<div class="empty-state" style="color:red;">Supabase client is NOT initialized. Please check your internet connection and reload. If this persists, contact support.</div>';
          }
          return;
        }

        // Check authentication - THIS IS THE ONLY AUTH CHECK
        currentUser = checkAuth(); // Don't specify role, allow both students and admins
        if (!currentUser) {
          console.log("‚ùå No user found, redirecting...");
          return; // checkAuth already redirects
        }

        console.log("‚úÖ User loaded:", currentUser);

        // Display user info
        const initials =
          (currentUser.first_name?.[0] || "") +
          (currentUser.last_name?.[0] || "");
        document.getElementById("userAvatar").textContent = initials || "üë§";
        document.getElementById("userName").textContent =
          `${currentUser.first_name || ""} ${
            currentUser.last_name || ""
          }`.trim() || "Student";
        document.getElementById("userEmail").textContent = currentUser.email;
        document.getElementById("userTier").textContent = (
          currentUser.tier || "LEAD"
        ).toUpperCase();

        // Stats
        document.getElementById("accountStatus").textContent =
          currentUser.is_active ? "Active" : "Inactive";
        document.getElementById("tierLevel").textContent = (
          currentUser.tier || "Lead"
        ).toUpperCase();

        if (currentUser.last_login_at) {
          const lastLogin = new Date(currentUser.last_login_at);
          document.getElementById("lastLogin").textContent =
            lastLogin.toLocaleDateString();
        } else {
          document.getElementById("lastLogin").textContent = "First time";
        }

        // --- Tier-specific dashboard header/message ---
        const dashHeader = document.querySelector(".dashboard-header");
        let tierMsg = "";
        switch ((currentUser.tier || "starter").toLowerCase()) {
          case "starter":
            tierMsg =
              "<div class='pill pill-starter' style='margin-top:8px;'>Starter Tier: Begin your journey! Unlock Core by passing FTMO.</div>";
            break;
          case "core":
            tierMsg =
              "<div class='pill pill-core' style='margin-top:8px;'>Core Tier: Advanced content unlocked! Pro tier available after funding proof.</div>";
            break;
          case "pro":
            tierMsg =
              "<div class='pill pill-pro' style='margin-top:8px;'>Pro Tier: Full access granted. Reach out for 1:1 mentorship!</div>";
            break;
          default:
            tierMsg = "";
        }
        if (dashHeader && tierMsg) {
          dashHeader.insertAdjacentHTML("beforeend", tierMsg);
        }

        // Load data
        await Promise.all([
          loadCourseMaterials(),
          loadPaymentHistory(),
          loadFTMOHistory(),
        ]);
      });

      async function loadCourseMaterials() {
        try {
          const tier = currentUser.tier || "starter";
          // Get selected categories from localStorage (set at enrollment)
          let selectedCategories = [];
          try {
            const catStr = localStorage.getItem("selectedCategories");
            if (catStr) {
              selectedCategories = JSON.parse(catStr);
            }
          } catch (e) {
            selectedCategories = [];
          }

          console.log(
            "üìö Loading courses for tier:",
            tier,
            "categories:",
            selectedCategories
          );

          let materials = [];
          let error = null;
          try {
            const result = await window.supabaseClient
              .from("course_materials")
              .select("*")
              .eq("is_published", true)
              .eq("tier", tier)
              .order("module", { ascending: true })
              .order("order_index", { ascending: true });
            materials = result.data || [];
            error = result.error;
          } catch (e) {
            error = e;
          }

          // Filter by selected categories if any are set
          let filteredMaterials = materials;
          if (selectedCategories && selectedCategories.length > 0) {
            filteredMaterials = materials.filter((m) => {
              // Assume each material has a 'category' field (string or array)
              if (!m.category) return false;
              if (Array.isArray(m.category)) {
                return m.category.some((cat) =>
                  selectedCategories.includes(cat)
                );
              } else {
                return selectedCategories.includes(m.category);
              }
            });
          }

          // Fallback: If no materials, use demo/static data
          if (!filteredMaterials || filteredMaterials.length === 0) {
            console.warn(
              "No course materials found from Supabase. Using demo/static data."
            );
            // --- DEMO DATA ---
            // You can replace or extend this for integration
            filteredMaterials = [
              {
                module: "Getting Started",
                title: "Welcome to the Academy",
                description: "Introduction to the platform and your journey.",
                content_type: "video",
                content_url: "https://www.w3schools.com/html/mov_bbb.mp4",
                category: selectedCategories[0] || "General",
              },
              {
                module: "Trading Basics",
                title: "What is Forex?",
                description: "Learn the basics of Forex trading.",
                content_type: "text",
                content_url:
                  "https://en.wikipedia.org/wiki/Foreign_exchange_market",
                category: selectedCategories[0] || "General",
              },
              {
                module: "Risk Management",
                title: "Risk Management 101",
                description: "How to protect your capital.",
                content_type: "pdf",
                content_url: "https://www.example.com/sample.pdf",
                category: selectedCategories[0] || "General",
              },
            ];
          }

          const container = document.getElementById("courseMaterials");

          if (!filteredMaterials || filteredMaterials.length === 0) {
            container.innerHTML =
              '<div class="empty-state">No course materials available for your tier and selected categories yet. Please contact support or update your enrollment.</div>';
            document.getElementById("coursesCount").textContent = "0";
            return;
          }

          // Group by module
          const grouped = {};
          filteredMaterials.forEach((m) => {
            if (!grouped[m.module]) grouped[m.module] = [];
            grouped[m.module].push(m);
          });

          document.getElementById("coursesCount").textContent =
            Object.keys(grouped).length;

          container.innerHTML = Object.entries(grouped)
            .map(
              ([module, items]) => `
          <div class="module-section">
            <h3>${module}</h3>
            <div class="material-list">
              ${items
                .map((item) => {
                  let contentHtml = "";
                  if (item.content_type === "video" && item.content_url) {
                    contentHtml = `
                        <video controls width="320" style="max-width:100%;border-radius:8px;box-shadow:0 2px 8px #0001;margin-bottom:8px;">
                          <source src="${item.content_url}" type="video/mp4">
                          Your browser does not support the video tag.
                        </video>
                        <a href="${item.content_url}" target="_blank" class="btn btn-secondary btn-small" style="margin-left:8px;">Open Video</a>
                      `;
                  } else {
                    contentHtml = `<a href="${item.content_url}" target="_blank" class="btn btn-secondary btn-small">View</a>`;
                  }
                  return `
                      <div class="material-item">
                        <span class="material-icon">${getContentIcon(
                          item.content_type
                        )}</span>
                        <div class="material-info">
                          <h4>${item.title}</h4>
                          <p>${item.description || "No description"}</p>
                        </div>
                        ${contentHtml}
                      </div>
                    `;
                })
                .join("")}
            </div>
          </div>
        `
            )
            .join("");
        } catch (err) {
          console.error("‚ùå Error loading courses:", err);
          document.getElementById("courseMaterials").innerHTML =
            '<div class="empty-state">Error loading courses. Please refresh the page.</div>';
        }
      }

      async function loadPaymentHistory() {
        try {
          console.log("üí≥ Loading payment history...");

          const { data, error } = await window.supabaseClient
            .from("payment_submissions")
            .select("*")
            .eq("user_id", currentUser.user_id)
            .order("submitted_at", { ascending: false });

          if (error) throw error;

          console.log("üí≥ Payments loaded:", data?.length || 0);

          const container = document.getElementById("paymentHistory");

          if (!data || data.length === 0) {
            container.innerHTML =
              '<div class="empty-state">No payment submissions yet.</div>';
            return;
          }

          container.innerHTML = data
            .map(
              (p) => `
          <div class="submission-item">
            <div>
              <strong>${p.tier.toUpperCase()}</strong> - $${p.amount}
              <br><span class="small" style="color: var(--text-light);">${new Date(
                p.submitted_at
              ).toLocaleDateString()}</span>
            </div>
            <span class="pill pill-${p.status}">${p.status.toUpperCase()}</span>
          </div>
        `
            )
            .join("");
        } catch (err) {
          console.error("‚ùå Error loading payments:", err);
          document.getElementById("paymentHistory").innerHTML =
            '<div class="empty-state">Error loading payment history.</div>';
        }
      }

      async function loadFTMOHistory() {
        try {
          console.log("üèÜ Loading FTMO history...");

          const { data, error } = await window.supabaseClient
            .from("ftmo_submissions")
            .select("*")
            .eq("user_id", currentUser.user_id)
            .order("submitted_at", { ascending: false });

          if (error) throw error;

          console.log("üèÜ FTMO submissions loaded:", data?.length || 0);

          const container = document.getElementById("ftmoHistory");

          if (!data || data.length === 0) {
            container.innerHTML =
              '<div class="empty-state">No FTMO submissions yet.</div>';
            return;
          }

          container.innerHTML = data
            .map(
              (f) => `
          <div class="submission-item">
            <div>
              <strong>${f.challenge_type}</strong>
              <br><span class="small" style="color: var(--text-light);">${new Date(
                f.submitted_at
              ).toLocaleDateString()}</span>
            </div>
            <span class="pill pill-${f.status}">${f.status.toUpperCase()}</span>
          </div>
        `
            )
            .join("");
        } catch (err) {
          console.error("‚ùå Error loading FTMO:", err);
          document.getElementById("ftmoHistory").innerHTML =
            '<div class="empty-state">Error loading FTMO history.</div>';
        }
      }

      function getContentIcon(type) {
        const icons = {
          video: "üé•",
          pdf: "üìÑ",
          text: "üìù",
        };
        return icons[type] || "üìö";
      }
    </script>
  </body>
</html>
