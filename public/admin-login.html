<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Login - PIP NATION ACADEMY</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="alternate icon" href="/favicon.ico" />
    <link rel="stylesheet" href="css/globals.css" />
    <link rel="stylesheet" href="css/components.css" />
    <link rel="stylesheet" href="css/pages/auth.css" />
  </head>
  <body class="auth-page">
    <div class="auth-wrap">
      <div class="text-center">
        <span class="admin-badge">üõ°Ô∏è ADMIN ACCESS</span>
      </div>
      <!-- <h1>Admin Login</h1> -->
      <p class="sub">Secure administrator portal</p>

      <div class="msg err d-none" id="errorMsg"></div>
      <div class="msg ok d-none" id="successMsg"></div>

      <form id="adminLoginForm">
        <label
          >Admin Email
          <input
            type="email"
            id="adminEmail"
            name="email"
            class="input"
            required
            placeholder="admin@forexmentor.com"
            autocomplete="email"
          />
        </label>
        <label
          >Password
          <input
            type="password"
            id="adminPassword"
            name="password"
            class="input"
            required
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            autocomplete="current-password"
          />
        </label>
        <button type="submit" class="btn btn-primary full-width">
          Login as Admin
        </button>
      </form>

      <div class="links mt-20 text-center">
        <p><a href="auth-modal.html">‚Üê Student Login</a></p>
        <p><a href="index.html">‚Üê Back to Home</a></p>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="js/config.js"></script>
    <script>
      const form = document.getElementById("adminLoginForm");
      const errorMsg = document.getElementById("errorMsg");
      const successMsg = document.getElementById("successMsg");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        errorMsg.style.display = "none";
        successMsg.style.display = "none";

        const email = document.getElementById("adminEmail").value.trim();
        const password = document.getElementById("adminPassword").value;

        try {
          const { data, error } = await window.supabaseClient.rpc(
            "verify_user_password",
            {
              p_email: email,
              p_password: password,
            }
          );

          if (error) throw new Error("Authentication failed");
          if (!data || data.length === 0) {
            errorMsg.textContent = "Invalid email or password";
            errorMsg.style.display = "block";
            return;
          }

          const user = data[0];

          if (!["admin", "super-admin", "limited-admin"].includes(user.role)) {
            errorMsg.textContent = "Access denied. Admin credentials required.";
            errorMsg.style.display = "block";
            return;
          }

          await window.supabaseClient.rpc("update_last_login", {
            p_user_id: user.user_id,
          });
          localStorage.setItem("user", JSON.stringify(user));
          localStorage.setItem("user_role", user.role);

          await window.supabaseClient.from("admin_audit_log").insert({
            admin_id: user.user_id,
            action: "login",
            resource_type: "auth",
            details: { email: user.email, role: user.role },
          });

          successMsg.textContent = "Admin login successful! Redirecting...";
          successMsg.style.display = "block";

          setTimeout(() => {
            window.location.href = "admin.html";
          }, 1000);
        } catch (err) {
          console.error("Admin login error:", err);
          errorMsg.textContent = "Login failed. Please try again.";
          errorMsg.style.display = "block";
        }
      });
    </script>
  </body>
</html>
