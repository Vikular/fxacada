<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Login - Forex Mentorship</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="alternate icon" href="/favicon.ico" />
    <link rel="stylesheet" href="css/globals.css" />
    <link rel="stylesheet" href="css/components.css" />
    <script src="js/includes.js" defer></script>
    <style>
      .lang-selector {
        position: absolute;
        top: 18px;
        right: 24px;
        z-index: 10;
        background: #fff;
        color: #222;
        border-radius: 6px;
        border: 1px solid #ccc;
        padding: 4px 10px;
        font-size: 15px;
      }
      body.dark-mode .lang-selector {
        background: #232526;
        color: #f3f4f6;
        border: 1px solid #444;
      }
    </style>
    <style>
      .auth-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .auth-wrap {
        background: #fff;
        border-radius: 16px;
        padding: 40px;
        max-width: 420px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }
      .auth-wrap h1 {
        margin: 0 0 8px;
        text-align: center;
      }
      .auth-wrap .sub {
        text-align: center;
        color: var(--text-light);
        margin: 0 0 24px;
      }
      .auth-wrap form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .auth-wrap label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-weight: 600;
        font-size: 14px;
      }
      .auth-wrap .links {
        font-size: 14px;
      }
      .auth-wrap .links a {
        color: var(--primary);
        font-weight: 600;
      }
    </style>
  </head>
  <body class="auth-page">
    <select
      id="lang-selector"
      class="lang-selector"
      aria-label="Select language"
    >
      <option value="en">English</option>
      <option value="zh">‰∏≠Êñá</option>
      <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
      <option value="es">Espa√±ol</option>
    </select>
    <div class="auth-wrap">
      <h1 data-i18n="Student Login">üîê Student Login</h1>
      <p class="sub" data-i18n="Access your forex mentorship dashboard">
        Access your forex mentorship dashboard
      </p>

      <div class="msg err" id="errorMsg" style="display: none"></div>
      <div class="msg ok" id="successMsg" style="display: none"></div>

      <form id="loginForm">
        <label data-i18n="Email"
          >Email
          <input
            type="email"
            id="email"
            name="email"
            class="input"
            required
            autocomplete="email"
          />
        </label>
        <label data-i18n="Password"
          >Password
          <input
            type="password"
            id="password"
            name="password"
            class="input"
            required
            autocomplete="current-password"
          />
        </label>
        <button
          type="submit"
          class="btn btn-primary full-width"
          data-i18n="Login"
        >
          Login
        </button>
      </form>

      <div class="links" style="margin-top: 20px; text-align: center">
        <p data-i18n="Don't have an account?">
          Don't have an account?
          <a href="enrollment.html" data-i18n="Enroll Now">Enroll Now</a>
        </p>
        <p>
          <a href="admin-login.html" data-i18n="Admin Login">Admin Login</a>
        </p>
        <p><a href="index.html" data-i18n="Back to Home">‚Üê Back to Home</a></p>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/config.js"></script>
    <script>
      // Set login placeholders on language change
      function setLoginPlaceholders() {
        if (window.i18next) {
          var emailInput = document.getElementById("email");
          var passwordInput = document.getElementById("password");
          if (emailInput)
            emailInput.placeholder =
              window.i18next.t("Email") + " (e.g. student@example.com)";
          if (passwordInput)
            passwordInput.placeholder =
              window.i18next.t("Password") + " (‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢)";
        }
      }
      document.addEventListener("DOMContentLoaded", function () {
        setLoginPlaceholders();
        if (window.i18next) {
          var origChangeLang = window.i18next.changeLanguage;
          window.i18next.changeLanguage = function (lang) {
            origChangeLang.call(window.i18next, lang);
            setTimeout(setLoginPlaceholders, 0);
          };
        }
      });

      const form = document.getElementById("loginForm");
      const errorMsg = document.getElementById("errorMsg");
      const successMsg = document.getElementById("successMsg");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        errorMsg.style.display = "none";
        successMsg.style.display = "none";

        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;

        try {
          const { data, error } = await window.supabaseClient.rpc(
            "verify_user_password",
            {
              p_email: email,
              p_password: password,
            }
          );

          if (error) throw new Error("Authentication failed");
          if (!data || data.length === 0) {
            errorMsg.textContent = "Invalid email or password";
            errorMsg.style.display = "block";
            return;
          }

          const user = data[0];

          if (["admin", "super-admin", "limited-admin"].includes(user.role)) {
            errorMsg.textContent = "Please use Admin Login for admin accounts";
            errorMsg.style.display = "block";
            return;
          }

          await window.supabaseClient.rpc("update_last_login", {
            p_user_id: user.user_id,
          });
          localStorage.setItem("user", JSON.stringify(user));
          localStorage.setItem("user_role", user.role);

          successMsg.textContent = "Login successful! Redirecting...";
          successMsg.style.display = "block";

          setTimeout(() => {
            window.location.href = "student.html";
          }, 1000);
        } catch (err) {
          console.error("Login error:", err);
          errorMsg.textContent = "Login failed. Please try again.";
          errorMsg.style.display = "block";
        }
      });
    </script>
  </body>
</html>
